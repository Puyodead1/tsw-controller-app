import useSWR from "swr";
import { lt as semverLt } from "semver";
import {
  GetProfiles,
  LoadConfiguration,
  SelectProfile,
  ClearProfile,
  GetSelectedProfiles,
  InstallTrainSimWorldMod,
  OpenConfigDirectory,
  GetLastInstalledModVersion,
  SetLastInstalledModVersion,
  GetVersion,
  GetControllers,
  OpenProfileBuilder,
  DeleteProfile,
  OpenNewProfileBuilder,
  SaveProfileForSharing,
  ImportProfile,
} from "../../../wailsjs/go/main/App";
import { useCallback, useEffect } from "react";
import { BrowserOpenURL, EventsOn } from "../../../wailsjs/runtime/runtime";
import { events } from "../../events";
import { useForm } from "react-hook-form";
import { MainTabControllerProfileSelector } from "./MainTabControllerProfileSelecor";
import { main } from "../../../wailsjs/go/models";
import { alert } from "../../utils/alert";
import { confirm } from "../../utils/confirm";

type FormValues = {
  profiles: Partial<Awaited<ReturnType<typeof GetSelectedProfiles>>>;
};

export const MainTab = () => {
  const { data: versionInfo, mutate: refetchVersionInfo } = useSWR(
    "version-info",
    () =>
      Promise.all([GetVersion(), GetLastInstalledModVersion()]).then(
        ([version, lastInstalledModVersion]) => ({
          version,
          lastInstalledModVersion,
        }),
      ),
    { revalidateOnMount: true },
  );
  const { data: profiles, mutate: refetchProfiles } = useSWR(
    "profiles",
    () => GetProfiles(),
    { revalidateOnMount: true },
  );
  const { data: controllers, mutate: refetchControllers } = useSWR(
    "controllers",
    () => GetControllers(),
    { revalidateOnMount: true },
  );

  const form = useForm<FormValues>({
    defaultValues: async () => ({
      profiles: await GetSelectedProfiles(),
    }),
  });
  const { watch, getValues } = form;

  const openInWindow = useCallback((url: string) => {
    BrowserOpenURL(url);
  }, []);

  const trySyncSelectedProfiles = useCallback(() => {
    const profiles = getValues("profiles");
    for (const guid in profiles) {
      if (profiles[guid]) {
        SelectProfile(guid, profiles[guid].Id).catch(() => {
          ClearProfile(guid);
          form.setValue(`profiles.${guid}`, undefined);
        });
      } else {
        ClearProfile(guid)
      }
    }
  }, [form]);

  const handleReloadConfiguration = () => {
    LoadConfiguration().then(trySyncSelectedProfiles);
  };

  const handleBrowseConfig = () => {
    OpenConfigDirectory();
  };

  const handleCreateProfile = (controller: main.Interop_GenericController) => {
    OpenNewProfileBuilder(controller.UsbID);
  };

  const handleOpenProfile = (controller: main.Interop_GenericController) => {
    const profile = getValues(`profiles.${controller.GUID}`);
    if (profile) OpenProfileBuilder(profile.Id);
  };

  const handleDeleteProfile = (controller: main.Interop_GenericController) => {
    const profile = getValues(`profiles.${controller.GUID}`);
    if (profile) {
      confirm({
        id: "confirm-delete",
        title: "Confirm delete profile?",
        message: "Are you sure you want to delete this profile?",
        actions: ["Cancel", "Confirm"],
        onConfirm: () => {
          DeleteProfile(profile.Id)
            .then(() => {
              form.setValue(`profiles.${controller.GUID}`, undefined);
              LoadConfiguration();
              ClearProfile(controller.GUID);
            })
            .catch((reason) => alert(String(reason), "error"));
        },
      });
    }
  };

  const handleSaveProfileForSharing = (
    controller: main.Interop_GenericController,
  ) => {
    const profile = getValues(`profiles.${controller.GUID}`);
    if (profile) SaveProfileForSharing(controller.GUID, profile.Id);
  };

  const handleInstall = () => {
    InstallTrainSimWorldMod()
      .then(() => refetchVersionInfo())
      .catch((err) => alert(String(err), "error"));
  };

  const handleImportProfile = () => {
    ImportProfile()
      .then(() => LoadConfiguration())
      .catch((err) => alert(String(err), "error"));
  };

  const handleIgnoreModInstallWarning = () => {
    if (versionInfo) {
      SetLastInstalledModVersion(versionInfo.version).then(() =>
        refetchVersionInfo(),
      );
    }
  };

  useEffect(() => {
    return watch(trySyncSelectedProfiles).unsubscribe;
  }, [trySyncSelectedProfiles]);

  useEffect(() => {
    return EventsOn(events.profiles_updated, () => {
      refetchProfiles();
    });
  }, []);

  useEffect(() => {
    return EventsOn(events.joydevices_updated, () => {
      refetchControllers();
    });
  }, []);

  return (
    <div className="grid grid-cols-1 grid-flow-row auto-rows-max gap-2">
      <div role="alert" className="alert alert-info alert-soft">
        <span>
          Want a quick start guide on how to create a profile from scratch?{" "}
          <button
            className="link"
            onClick={() =>
              openInWindow("https://tsw-controller-app.vercel.app/docs")
            }
          >
            Check out the online documentation
          </button>
        </span>
      </div>
      <div>
        {controllers?.map((c) => (
          <div key={c.GUID}>
            <MainTabControllerProfileSelector
              controller={c}
              profiles={profiles ?? []}
              form={form}
              onBrowseConfiguration={handleBrowseConfig}
              onCreateProfile={handleCreateProfile}
              onReloadConfiguration={handleReloadConfiguration}
              onSaveControllerProfileForSharing={handleSaveProfileForSharing}
              onOpenProfileForController={handleOpenProfile}
              onDeleteProfileForController={handleDeleteProfile}
            />
          </div>
        ))}
      </div>
      <p className="text-xs text-base-content/50">
        Note: for auto-detection to work it has to be supported by the profile and the TSW API needs to be configured
      </p>
      <div className="divider"></div>
      {/* steam://controllerconfig/2967990/3576092503 */}
      <div className="flex gap-2">
        <button className="btn btn-sm grow" onClick={handleInstall}>
          Install/Reinstall Train Sim World mod
        </button>
        <button className="btn btn-sm grow" onClick={handleImportProfile}>
          Import profile (.tswprofile)
        </button>
      </div>
      {!versionInfo?.lastInstalledModVersion && (
        <div role="alert" className="alert alert-soft alert-warning">
          <span>
            It looks like you have not installed the Train Sim World mod yet,
            make sure you install the mod first.
          </span>
          <div>
            <button
              className="btn btn-sm"
              onClick={handleIgnoreModInstallWarning}
            >
              Ignore
            </button>
          </div>
        </div>
      )}
      {versionInfo?.lastInstalledModVersion &&
        semverLt(versionInfo.lastInstalledModVersion, versionInfo.version) && (
          <div role="alert" className="alert alert-soft alert-warning">
            <span>
              It looks like the app has updated since the last time you
              installed the mod, make sure to reinstall the updated mod version
              before starting the game.
            </span>
            <div>
              <button
                className="btn btn-sm"
                onClick={handleIgnoreModInstallWarning}
              >
                Ignore
              </button>
            </div>
          </div>
        )}
      <div role="alert" className="alert">
        <span>
          <strong>Mod Installation Notice</strong>
          <br />
          The mod is not required to install but recommended for full
          compatibility. Without the mod you will not be able to use the
          "direct_control" or "sync_control" control modes. You will have access
          to the "api_control" control mode, and any regular key bind
          assignments as long as the TSW API key is configured properly (see
          Settings).
        </span>
      </div>
      <div role="alert" className="alert">
        <span>
          <strong>Controller Setup Notice</strong>
          <br />
          For this app to correctly work you will need to make sure Train Sim
          World is not able to process the controller input. You can achieve
          this by configuring your controller using in Steam using{" "}
          <button
            className="inline link"
            onClick={() =>
              openInWindow(
                "https://github.com/LiamMartens/tsw-controller-app/blob/main/STEAM_INPUT_SETUP.md",
              )
            }
          >
            Steam Input
          </button>{" "}
          and applying the "Disabled Controller" layout preset for the game (see
          "Steam Input" link). Alternatively, you can also use a software like{" "}
          <button
            className="inline link"
            onClick={() =>
              openInWindow("https://ds4-windows.com/download/hidhide/")
            }
          >
            HidHide
          </button>{" "}
          to hide the controller from the game altogether
        </span>
      </div>
    </div>
  );
};
