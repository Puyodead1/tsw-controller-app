import { DeepPartial, useForm } from "react-hook-form";
import {
  GetPreferredControlMode,
  GetTSWAPIKeyLocation,
  SetPreferredControlMode,
  SetTSWAPIKeyLocation,
  GetAlwaysOnTop,
  SetAlwaysOnTop,
  GetTheme,
  SetTheme,
} from "../../../wailsjs/go/main/App";
import { alert } from "../../utils/alert";
import { BrowserOpenURL } from "../../../wailsjs/runtime/runtime";
import { updateTheme } from "../../utils/updateTheme";

type FormValues = {
  tswApiKeyLocation: string;
  preferredControlMode: "direct_control" | "sync_control" | "api_control";
  alwaysOnTop: boolean;
  theme: "system" | "light" | "dark";
};

const getRemoteFormValues = async () => ({
  tswApiKeyLocation: await GetTSWAPIKeyLocation(),
  preferredControlMode:
    (await GetPreferredControlMode()) as FormValues["preferredControlMode"],
  alwaysOnTop: await GetAlwaysOnTop(),
  theme: (await GetTheme()) as FormValues["theme"],
});

export const SettingsTab = () => {
  const { register, formState, reset, handleSubmit } = useForm<FormValues>({
    defaultValues: async () => getRemoteFormValues(),
  });

  const handleOpenForumLink = () => {
    BrowserOpenURL(
      "https://forums.dovetailgames.com/threads/train-sim-world-api-support.94488/",
    );
  };

  const handleSubmitSuccess = async (values: FormValues) => {
    const promises: Promise<void>[] = [];
    const currentValues = await getRemoteFormValues();

    if (values.theme  !== currentValues.theme) {
      updateTheme(values.theme)
      promises.push(SetTheme(values.theme))
    }

    if (
      values.tswApiKeyLocation !== currentValues.tswApiKeyLocation
    ) {
      promises.push(SetTSWAPIKeyLocation(values.tswApiKeyLocation));
    }

    if (
      values.preferredControlMode &&
      values.preferredControlMode !== currentValues.preferredControlMode
    ) {
      promises.push(SetPreferredControlMode(values.preferredControlMode));
    }

    if (values.alwaysOnTop !== currentValues.alwaysOnTop) {
      promises.push(SetAlwaysOnTop(values.alwaysOnTop));
    }

    if (promises.length) {
      Promise.all(promises).then(() => {
        reset(values);
        alert("Saved settings", "success");
      });
    }
  };

  return (
    <form
      className="grid grid-cols-1 grid-flow-row auto-rows-max gap-2"
      onSubmit={handleSubmit(handleSubmitSuccess)}
    >
      <fieldset className="fieldset">
        <label htmlFor="ui-theme" className="fieldset-legend">
          Theme
        </label>
        <select
          id="ui-theme"
          className="select w-full"
          {...register("theme")}
        >
          <option value="system">System</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </fieldset>
      <fieldset className="fieldset">
        <label htmlFor="preferred-control-mode" className="fieldset-legend">
          Preferred Control Mode
        </label>
        <select
          id="preferred-control-mode"
          className="select w-full"
          {...register("preferredControlMode")}
        >
          <option value="direct_control">Direct Control</option>
          <option value="sync_control">Sync Control</option>
          <option value="api_control">API Control</option>
        </select>
        <p className="fieldset-label whitespace-normal">
          Sets which control mode to prefer if multiple are defined
        </p>
      </fieldset>
      <fieldset className="fieldset">
        <label htmlFor="tsw-api-key-location" className="fieldset-legend">
          TSW API Key Location
        </label>
        <input
          id="tsw-api-key-location"
          className="input w-full"
          {...register("tswApiKeyLocation")}
        />
        <p className="fieldset-label whitespace-normal">
          If the location has not been auto-detected you will need to enter it
          manually here. The API key is only requred for the "api_control"
          control mode.
        </p>
      </fieldset>
      <fieldset className="fieldset bg-base-100 border-base-300 rounded-box border p-4 w-full">
        <legend className="fieldset-legend">Other options</legend>
        <label className="label">
          <input
            type="checkbox"
            className="checkbox"
            {...register("alwaysOnTop")}
          />
          Always on top
        </label>
      </fieldset>
      <div role="alert" className="alert">
        <span>
          <strong>TSW API Notice</strong>
          <br />
          The API connection only works if -HTTPAPI is enabled in Train Sim
          World. You can find instructions in the linked PDF on the{" "}
          <button type="button" className="link" onClick={handleOpenForumLink}>
            online forum
          </button>
          .
        </span>
      </div>
      <div className="flex justify-end">
        <button
          type="submit"
          className="btn btn-primary"
          disabled={
            formState.disabled || !formState.isDirty || formState.isSubmitting
          }
        >
          Save
        </button>
      </div>
    </form>
  );
};
